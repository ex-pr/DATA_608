---
title: "Story - 5: What Is The Effect Of The Earth's Temperature on Cyclonic Storms?"
author: 'Daria Dubovskaia'
runtime: shiny
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
    code_folding: hide
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

#author: 'Daria Dubovskaia'
#runtime: shiny
#output:
# chunks
knitr::opts_chunk$set(eval=TRUE, message=FALSE, warning=FALSE, fig.height=5, fig.align='center')

# Load libraries
library(tidyverse)
library(ggplot2)
library(readxl)
library(openxlsx) 
library(httr)
library(janitor)
library('xml2')
library(rvest)
library(shiny)
library(leaflet)
library(sf)
library(rjson)
library(plotly)
```


## Overview


## 1. Data Preparation

### 1.1 Load data

```{r bystate_data}
# Path to excel book
path <- "C:/Users/daria/Downloads/food1_by_state.xlsx"
  
# Get data from sheets 
sheets <- openxlsx::getSheetNames(path) 
df_1 <- lapply(sheets, openxlsx::read.xlsx, xlsxFile=path) 
  
# Assign state names to data frame 
names(df_1) <- sheets 
```

```{r obesity_data}
# Url to obesity table 
url <- "https://millennialcities.com/childhood-obesity-rates-by-state-ranking-from-highest-to-lowest/"
webpage <- read_html(url)

# Get the first table found
df_2 <- webpage %>%
  html_table(fill = TRUE) %>% 
  .[[1]]
```


```{r geo_data}
# Read geo data json
us_states_sf <- rjson::fromJSON(file='C:/Users/daria/Downloads/gz_2010_us_040_00_5m.json')
```

### 1.2 Summary Statistics

### 1.3 Data cleaning


```{r state_names}
# Change col_names
state_names <- c("AK" = "Alaska" , "AL" =  "Alabama", "AR" =  "Arkansas", 
                 "AZ" = "Arizona", "CA" = "California", "CO"=  "Colorado",
                 "CT" =  "Connecticut" ,  
                 "DE"= "Delaware", "FL"="Florida", "GA"= "Georgia", 
                 "HI"= "Hawaii", "IA"= "Iowa", "ID"= "Idaho", "IL"="Illinois",
                 "IN"="Indiana", "KS"="Kansas", "KY"="Kentucky",
                 "LA"="Louisiana", "MA" = "Massachusetts", "MD" = "Maryland",
                 "ME" = "Maine", "MI" = "Michigan", "MN" = "Minnesota",
                 "MO" = "Missouri", "MS" = "Mississippi", "MT" = "Montana",
                 "NC" = "North Carolina", "ND" = "North Dakota", "NE" = "Nebraska",
                 "NH" = "New Hampshire", "NJ" = "New Jersey", "NM" = "New Mexico",
                 "NV" = "Nevada", "NY" = "New York", "OH" = "Ohio", 
                 "OK" = "Oklahoma", "OR" = "Oregon", "PA" = "Pennsylvania",
                 "RI" = "Rhode Island", "SC" = "South Carolina", 
                 "SD" = "South Dakota", "TN" = "Tennessee", "TX" = "Texas",
                 "UT" = "Utah", "VA" = "Virginia", "VT" = "Vermont",
                 "WA" = "Washington", "WI" = "Wisconsin", "WV" = "West Virginia",
                 "WY" = "Wyoming", "US" = "National")

abbrev_state_names <- setNames(names(state_names), state_names)

#obesity_df <- obesity_df %>%
#  mutate(State = recode(State, !!!abbrev_state_names)) %>%
  #select(-c(1))
```

```{r obesity_clean}
# Copy data
obesity_df <- df_2

# Add columns to correspond with geo data and food insecutiry data
obesity_df <- obesity_df %>% 
  add_row(State = "Puerto Rico") %>% 
  add_row(State = "District of Columbia")
obesity_df <- obesity_df[!grepl("National", obesity_df$State),]
```

```{r state_data}
# Copy data with only US in general, 50 states and DC
food_insecurity_list <- df_1[1:52]

for (state in names(food_insecurity_list)) {
  df <- food_insecurity_list[[state]][-c(1:5, 7, 13, 16:34, 39, 40, 45, 51, 59, 62:84, 94:188), -c(3, 4, 7)]
  colnames(df) <- c("Select characteristics", "Total", "Sometimes not enough to eat", "Often not enough to eat") 
  
# Replace '-' with NA
  df[df == "-"] <- NA
  
# Transform the 2nd, 3rd, and 4th columns to numeric
  df[, c("Total", "Sometimes not enough to eat", "Often not enough to eat")] <- sapply(df[, c("Total", "Sometimes not enough to eat", "Often not enough to eat")], as.numeric)
  
# Calculate food insecurity rate
  df$`Food Insecurity Rate` <- with(df, (`Sometimes not enough to eat` + `Often not enough to eat`) / Total * 100)
  
# Transpose the dataframe
  df_t <- as.data.frame(t(df))
  
# Reset numeric row names
  colnames(df_t) <- df_t[1, ] # Set the first row as the column names
  df_t <- df_t[-1, ] # Remove the first row since it's now the column names
  df_t <- df_t[-c(1:3),]

# Rename the last row to match the state name
  rownames(df_t) <- state
  
# Transform to numeric
  df_t <- sapply(df_t, as.numeric)
  
# Assign modified df back to list
  food_insecurity_list[[state]] <- df_t
}

# Combine all dataframes in one
food_insecurity_df <- bind_rows(food_insecurity_list, .id = "State")

# Reset the row indices 
row.names(food_insecurity_df) <- NULL
```



```{r fix_states}
# Remove National data to correspond with geo data
food_insecurity_data <- food_insecurity_df[-1, ]

# Use full state names instead of abbrev
food_insecurity_data <- food_insecurity_data %>%
  mutate(State = recode(State, !!!state_names))

# Add rows to to correspond with geo data
food_insecurity_data$State[which(food_insecurity_data$State=="DC")] <- "District of Columbia"
food_insecurity_data <- food_insecurity_data %>% add_row(State = "Puerto Rico")

# Join food insecurity data with the geojson data
#geo_data <- left_join(us_states_sf, food_insecurity_data, by = c("NAME" = "State"))

# Join obesity and food insecutiry by state
food_obesity_df <- cbind(food_insecurity_data, obesity_df)
```


```{r us_data}
# Keep us detailed data separate
us_food_df <- df_1[[1]]

# Remove some rows
us_food_df <- us_food_df[-c(1:5, 7, 13, 16:34, 39, 40, 45, 51, 59, 62:84, 94:188), ]

# Change col names
colnames(us_food_df) <- c("Select characteristics", "Total", "Enough of the kinds of food wanted", 
"Enough food, but not always the kinds wanted", "Sometimes not enough to eat", "Often not enough to eat","Did not report") 

# Replace '-' with NA
us_food_df[us_food_df == "-"] <- NA

# Transform columns to numeric
us_food_df <- us_food_df %>%
    mutate(across(-c(`Select characteristics`), as.numeric))
```


```{r}
write.csv(food_insecurity_data, "C:/Users/daria/Downloads/food_insecurity_data.csv")
```





## 2. Analysis


```{r}
# UI for selecting demographics
ui <- fluidPage(
  titlePanel("Food Insecurity Rates by State"),
  selectInput("demographic", "Choose a Demographic:",
              choices = c("Total" = "Total",
                          "Female" = "    Female",
                          "Male" = "    Male",
                          "Less than $25,000" = "    Less than $25,000",
                          "Children in household" = "    Children in household")), 
  plotlyOutput("map")
) 

# Server logic and Plotly map rendering
server <- function(input, output) {
  output$map <- renderPlotly({
    # Dynamically set the domain for the color palette
   # pal <- colorNumeric(palette = "RdYlOr", domain = food_insecurity_data[[input$demographic]])
    
  # Ensure the selected demographic column exists
  if (!(input$demographic %in% names(food_insecurity_data))) {
    return(NULL)
  }
    
    # Dynamically set the z-axis data based on selected demographic
  z_data <- food_insecurity_data[[input$demographic]]

plot_ly() %>% add_trace(
    type="choropleth",
    geojson=us_states_sf,
    locations=food_insecurity_data$State,
    featureidkey='properties.NAME',
    #z=food_insecurity_data$Total,
    z = z_data,
    colorscale = 'RdYlOr',
    zmin=6,
    zmax=15,
    marker=list(line=list(
      width=0))) %>% 
  colorbar(title = "Food Insecurity Rate") %>% 
  layout(title = "Food Insecurity Rate by" ~ input$demographic) %>% 
  layout(geo = list(scope = 'usa', projection = list(type = 'albers usa'), showlakes = TRUE, lakecolor = toRGB('white')))
  })
}

# Run the app
shinyApp(ui = ui, server = server)
```

```{r}
us_geo <- st_read('C:/Users/daria/Downloads/gz_2010_us_040_00_5m.json')
```


Food Insecurity by Demographics: Analyze food insecurity rates across states, broken down by income level, gender, and presence of children. Use this data to show the higher vulnerability of low-income families, particularly those with children.
Childhood Nutrition and Poverty: Explore the correlation between childhood obesity rates and poverty levels by state. This will highlight how limited access to healthy food choices impacts children's health.
Long-Term Effects: Utilize data on the effects of childhood malnutrition to showcase how it hinders cognitive development and increases the risk of chronic health problems in adulthood. This can lead to a cycle of poverty and dependence on social services.

Data Visualization
Interactive Map: Create a map where viewers can select a state and see the corresponding food insecurity rates for different demographics. Highlight states with the highest food insecurity rates.
Stacked Bar Charts: Show food insecurity rates by income level within each state, allowing for easy comparison across states.
Line Charts: Use line charts to demonstrate the correlation between childhood obesity rates and poverty levels across different states.
Impact Infographic: Create an infographic showcasing the long-term consequences of childhood malnutrition on health, education, and future earning potential.
Tailoring the Message for Policymakers
Focus on Economic Impact: Frame the issue not just as a humanitarian concern but also as an economic burden. Highlight the potential savings from reduced healthcare costs and increased workforce productivity by addressing childhood hunger.
State-Specific Data: Use the map visualization to present state-specific data, allowing policymakers to see the situation within their constituencies.
Long-Term Investment: Emphasize that addressing food insecurity is an investment in the future. By ensuring proper childhood nutrition, we can create a healthier and more productive workforce.



https://www.ers.usda.gov/topics/food-nutrition-assistance/food-security-in-the-u-s/interactive-charts-and-highlights/

https://map.feedingamerica.org/district/2021/overall

https://www.census.gov/data/tables/2022/demo/hhp/hhp44.html

https://millennialcities.com/childhood-obesity-rates-by-state-ranking-from-highest-to-lowest/
